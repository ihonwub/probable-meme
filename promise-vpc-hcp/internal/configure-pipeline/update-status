#!/usr/bin/env sh
set -euo pipefail
echo "üü¢ Running update-status script..."

vpcName=$(yq '.status.vpcName' /kratix/input/object.yaml)
region="us-east-1"

attempts=0
max_attempts=6
sleep_seconds=45
vpc_id=""

while [ "$attempts" -lt "$max_attempts" ]; do
  echo "üîÅ Attempt $(($attempts + 1)) to find VPC named: $vpcName"
  
  vpc_id=$(aws ec2 describe-vpcs \
    --region "$region" \
    --filters "Name=tag:Name,Values=$vpcName" \
    --query "Vpcs[0].VpcId" \
    --output text) || true

  if [ "$vpc_id" != "None" ] && [ -n "$vpc_id" ]; then
    echo "‚úÖ VPC found: $vpc_id"
    
    # Create status.yaml to mark the resource ready
    cat <<EOF > /kratix/metadata/status.yaml
ready: "True"
vpcId: "$vpc_id"
vpcName: "$vpcName"
EOF

    echo "‚úÖ VPC $vpcName is ready with ID: $vpc_id"
    exit 0
  fi

  echo "‚ö†Ô∏è VPC not found yet. Retrying in $sleep_seconds seconds..."
  attempts=$(($attempts + 1))
  sleep "$sleep_seconds"
done

echo "‚ùå Failed to find VPC with Name tag: $vpcName after $max_attempts attempts"
exit 1
